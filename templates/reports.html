{% extends "base.html" %}
{% block title %}Reports & Analytics - DCA Platform{% endblock %}

{% block content %}
<div class="dashboard-container">
    <!-- Page Header -->
    <div class="page-header mb-4">
        <div class="row align-items-center">
            <div class="col-md-6">
                <h1 class="page-title">
                    <i class="fas fa-chart-bar me-2"></i>Reports & Analytics
                </h1>
                <p class="page-subtitle">Comprehensive insights and performance analytics</p>
            </div>
            <div class="col-md-6 text-end">
                <div class="btn-group" role="group">
                    <button type="button" class="btn btn-primary" onclick="generateReport()">
                        <i class="fas fa-file-export me-2"></i>Generate Report
                    </button>
                    <button type="button" class="btn btn-outline-primary" onclick="refreshData()">
                        <i class="fas fa-sync-alt me-2"></i>Refresh
                    </button>
                    <div class="dropdown">
                        <button class="btn btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                            <i class="fas fa-download me-2"></i>Export
                        </button>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="#" onclick="exportReport('pdf')"><i class="fas fa-file-pdf me-2"></i>PDF</a></li>
                            <li><a class="dropdown-item" href="#" onclick="exportReport('excel')"><i class="fas fa-file-excel me-2"></i>Excel</a></li>
                            <li><a class="dropdown-item" href="#" onclick="exportReport('csv')"><i class="fas fa-file-csv me-2"></i>CSV</a></li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Date Range Selector -->
    <div class="card mb-4">
        <div class="card-body">
            <div class="row g-3 align-items-center">
                <div class="col-md-3">
                    <label class="form-label">Report Type</label>
                    <select class="form-select" id="reportType" onchange="changeReportType()">
                        <option value="performance">Performance Report</option>
                        <option value="agency">Agency Performance</option>
                        <option value="recovery">Recovery Analysis</option>
                        <option value="compliance">Compliance Report</option>
                        <option value="financial">Financial Summary</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label">Date Range</label>
                    <select class="form-select" id="dateRange" onchange="updateDateRange()">
                        <option value="today">Today</option>
                        <option value="yesterday">Yesterday</option>
                        <option value="week">This Week</option>
                        <option value="month" selected>This Month</option>
                        <option value="quarter">This Quarter</option>
                        <option value="year">This Year</option>
                        <option value="custom">Custom Range</option>
                    </select>
                </div>
                <div class="col-md-6" id="customDateRange" style="display: none;">
                    <div class="row g-2">
                        <div class="col-md-5">
                            <label class="form-label">From Date</label>
                            <input type="date" class="form-control" id="startDate">
                        </div>
                        <div class="col-md-5">
                            <label class="form-label">To Date</label>
                            <input type="date" class="form-control" id="endDate">
                        </div>
                        <div class="col-md-2 d-flex align-items-end">
                            <button class="btn btn-primary w-100" onclick="applyCustomRange()">Apply</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Key Metrics -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card metric-card">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="card-subtitle mb-2">Total Recovery</h6>
                            <h2 class="card-title" id="totalRecovery">$0</h2>
                            <small class="text-success">
                                <i class="fas fa-arrow-up me-1"></i>
                                <span id="recoveryGrowth">0%</span> growth
                            </small>
                        </div>
                        <i class="fas fa-dollar-sign fa-2x text-success opacity-50"></i>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card metric-card">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="card-subtitle mb-2">Recovery Rate</h6>
                            <h2 class="card-title" id="recoveryRate">0%</h2>
                            <small class="text-success">
                                <i class="fas fa-arrow-up me-1"></i>
                                <span id="rateGrowth">0%</span> vs last period
                            </small>
                        </div>
                        <i class="fas fa-chart-line fa-2x text-info opacity-50"></i>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card metric-card">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="card-subtitle mb-2">Avg Recovery Time</h6>
                            <h2 class="card-title" id="avgRecoveryTime">0 days</h2>
                            <small class="text-success">
                                <i class="fas fa-arrow-down me-1"></i>
                                <span id="timeImprovement">0%</span> improvement
                            </small>
                        </div>
                        <i class="fas fa-clock fa-2x text-warning opacity-50"></i>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card metric-card">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="card-subtitle mb-2">SLA Compliance</h6>
                            <h2 class="card-title" id="slaCompliance">0%</h2>
                            <small class="text-success">
                                <i class="fas fa-arrow-up me-1"></i>
                                <span id="slaGrowth">0%</span> improvement
                            </small>
                        </div>
                        <i class="fas fa-shield-alt fa-2x text-primary opacity-50"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Charts Section -->
    <div class="row mb-4">
        <div class="col-md-8">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">Recovery Trend</h5>
                </div>
                <div class="card-body">
                    <canvas id="recoveryTrendChart" height="250"></canvas>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">Case Status Distribution</h5>
                </div>
                <div class="card-body">
                    <canvas id="caseDistributionChart" height="250"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Agency Performance Table -->
    <div class="card mb-4">
        <div class="card-header">
            <h5 class="card-title mb-0">Agency Performance Ranking</h5>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-hover" id="agencyRankingTable">
                    <thead>
                        <tr>
                            <th width="50">Rank</th>
                            <th>Agency</th>
                            <th>Recovery Rate</th>
                            <th>SLA Compliance</th>
                            <th>Total Cases</th>
                            <th>Recovered Amount</th>
                            <th>Success Rate</th>
                            <th>Performance Score</th>
                        </tr>
                    </thead>
                    <tbody id="agencyRankingBody">
                        <!-- Data loaded dynamically -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Detailed Analysis -->
    <div class="row">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">Top Performing Agencies</h5>
                </div>
                <div class="card-body">
                    <canvas id="topAgenciesChart" height="200"></canvas>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">Recovery by Case Size</h5>
                </div>
                <div class="card-body">
                    <canvas id="recoveryBySizeChart" height="200"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Report Generator Modal -->
<div class="modal fade" id="reportGeneratorModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-file-export me-2"></i>Generate Custom Report
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="reportForm" onsubmit="generateCustomReport(event)">
                <div class="modal-body">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label">Report Title *</label>
                            <input type="text" class="form-control" name="title" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Report Type</label>
                            <select class="form-select" name="type">
                                <option value="detailed">Detailed Analysis</option>
                                <option value="summary">Executive Summary</option>
                                <option value="agency">Agency Performance</option>
                                <option value="compliance">Compliance Report</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Date Range *</label>
                            <select class="form-select" name="period" required>
                                <option value="month">Last Month</option>
                                <option value="quarter">Last Quarter</option>
                                <option value="year">Last Year</option>
                                <option value="custom">Custom Range</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Format</label>
                            <select class="form-select" name="format">
                                <option value="pdf">PDF</option>
                                <option value="excel">Excel</option>
                                <option value="html">HTML</option>
                            </select>
                        </div>
                        <div class="col-12">
                            <label class="form-label">Include Sections</label>
                            <div class="row">
                                <div class="col-md-4">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" name="sections" value="summary" checked>
                                        <label class="form-check-label">Executive Summary</label>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" name="sections" value="performance" checked>
                                        <label class="form-check-label">Performance Metrics</label>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" name="sections" value="agency" checked>
                                        <label class="form-check-label">Agency Analysis</label>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" name="sections" value="trends">
                                        <label class="form-check-label">Trends Analysis</label>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" name="sections" value="recommendations">
                                        <label class="form-check-label">Recommendations</label>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" name="sections" value="appendix">
                                        <label class="form-check-label">Appendix</label>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-12">
                            <label class="form-label">Email Report To</label>
                            <input type="email" class="form-control" name="email" placeholder="Optional: Enter email to receive report">
                        </div>
                        <div class="col-12">
                            <label class="form-label">Notes/Description</label>
                            <textarea class="form-control" name="notes" rows="3" placeholder="Add any additional notes or description for this report..."></textarea>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-magic me-2"></i>Generate Report
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let charts = {};

document.addEventListener('DOMContentLoaded', function() {
    loadReportData();
    initializeDatePickers();
});

function loadReportData() {
    const reportType = document.getElementById('reportType').value;
    const dateRange = document.getElementById('dateRange').value;
    
    fetch(`/api/report-data?type=${reportType}&range=${dateRange}`)
        .then(response => response.json())
        .then(data => {
            updateMetrics(data.metrics);
            updateCharts(data.charts);
            updateAgencyRanking(data.agencies);
        })
        .catch(error => {
            console.error('Error loading report data:', error);
        });
}

function updateMetrics(metrics) {
    document.getElementById('totalRecovery').textContent = `$${formatCurrency(metrics.total_recovery)}`;
    document.getElementById('recoveryGrowth').textContent = `${metrics.recovery_growth || 0}%`;
    document.getElementById('recoveryRate').textContent = `${metrics.recovery_rate || 0}%`;
    document.getElementById('rateGrowth').textContent = `${metrics.rate_growth || 0}%`;
    document.getElementById('avgRecoveryTime').textContent = `${metrics.avg_recovery_time || 0} days`;
    document.getElementById('timeImprovement').textContent = `${metrics.time_improvement || 0}%`;
    document.getElementById('slaCompliance').textContent = `${metrics.sla_compliance || 0}%`;
    document.getElementById('slaGrowth').textContent = `${metrics.sla_growth || 0}%`;
}

function updateCharts(chartData) {
    // Update or create charts
    updateTrendChart(chartData.trend);
    updateDistributionChart(chartData.distribution);
    updateTopAgenciesChart(chartData.top_agencies);
    updateSizeChart(chartData.by_size);
}

function updateTrendChart(data) {
    const ctx = document.getElementById('recoveryTrendChart').getContext('2d');
    
    if (charts.trend) {
        charts.trend.destroy();
    }
    
    charts.trend = new Chart(ctx, {
        type: 'line',
        data: {
            labels: data.labels || ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'],
            datasets: [{
                label: 'Recovery Amount ($)',
                data: data.values || [12000, 19000, 15000, 25000, 22000, 30000],
                borderColor: '#3498db',
                backgroundColor: 'rgba(52, 152, 219, 0.1)',
                tension: 0.4,
                fill: true
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) {
                            return '$' + value.toLocaleString();
                        }
                    }
                }
            }
        }
    });
}

function updateDistributionChart(data) {
    const ctx = document.getElementById('caseDistributionChart').getContext('2d');
    
    if (charts.distribution) {
        charts.distribution.destroy();
    }
    
    charts.distribution = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: data.labels || ['Recovered', 'Active', 'Pending', 'Closed'],
            datasets: [{
                data: data.values || [45, 30, 15, 10],
                backgroundColor: [
                    '#27ae60',
                    '#f39c12',
                    '#3498db',
                    '#95a5a6'
                ],
                borderWidth: 2,
                borderColor: '#fff'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            cutout: '70%',
            plugins: {
                legend: {
                    position: 'bottom'
                }
            }
        }
    });
}

function updateTopAgenciesChart(data) {
    const ctx = document.getElementById('topAgenciesChart').getContext('2d');
    
    if (charts.topAgencies) {
        charts.topAgencies.destroy();
    }
    
    charts.topAgencies = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: data.labels || ['Agency A', 'Agency B', 'Agency C', 'Agency D'],
            datasets: [{
                label: 'Recovery Rate (%)',
                data: data.values || [85, 78, 92, 65],
                backgroundColor: 'rgba(102, 126, 234, 0.8)',
                borderColor: 'rgba(102, 126, 234, 1)',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    max: 100,
                    ticks: {
                        callback: function(value) {
                            return value + '%';
                        }
                    }
                }
            }
        }
    });
}

function updateSizeChart(data) {
    const ctx = document.getElementById('recoveryBySizeChart').getContext('2d');
    
    if (charts.sizeChart) {
        charts.sizeChart.destroy();
    }
    
    charts.sizeChart = new Chart(ctx, {
        type: 'pie',
        data: {
            labels: data.labels || ['Small (<$1k)', 'Medium ($1k-10k)', 'Large (>$10k)'],
            datasets: [{
                data: data.values || [35, 45, 20],
                backgroundColor: [
                    '#e74c3c',
                    '#3498db',
                    '#2ecc71'
                ],
                borderWidth: 2,
                borderColor: '#fff'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom'
                }
            }
        }
    });
}

function updateAgencyRanking(agencies) {
    const tbody = document.getElementById('agencyRankingBody');
    
    tbody.innerHTML = agencies.map((agency, index) => `
        <tr>
            <td>
                <div class="rank-badge rank-${index + 1}">
                    ${index + 1}
                </div>
            </td>
            <td>
                <div class="d-flex align-items-center">
                    <div class="agency-icon-small me-2">
                        <i class="fas fa-building"></i>
                    </div>
                    <div>
                        <div class="fw-medium">${agency.name}</div>
                        <small class="text-muted">${agency.code}</small>
                    </div>
                </div>
            </td>
            <td>
                <div class="progress" style="height: 20px;">
                    <div class="progress-bar" role="progressbar" 
                         style="width: ${agency.recovery_rate}%"
                         aria-valuenow="${agency.recovery_rate}" 
                         aria-valuemin="0" 
                         aria-valuemax="100">
                        ${agency.recovery_rate}%
                    </div>
                </div>
            </td>
            <td>
                <span class="badge ${getSlaBadgeClass(agency.sla_compliance)}">
                    ${agency.sla_compliance}%
                </span>
            </td>
            <td>${agency.total_cases}</td>
            <td>
                <strong>$${formatCurrency(agency.recovered_amount)}</strong>
            </td>
            <td>
                <span class="badge ${getSuccessBadgeClass(agency.success_rate)}">
                    ${agency.success_rate}%
                </span>
            </td>
            <td>
                <div class="performance-score">
                    <span class="score-value">${agency.performance_score}</span>
                    <div class="score-bar">
                        <div class="score-fill" style="width: ${agency.performance_score}%"></div>
                    </div>
                </div>
            </td>
        </tr>
    `).join('');
}

function getSlaBadgeClass(compliance) {
    if (compliance >= 95) return 'bg-success';
    if (compliance >= 90) return 'bg-warning';
    return 'bg-danger';
}

function getSuccessBadgeClass(successRate) {
    if (successRate >= 80) return 'bg-success';
    if (successRate >= 60) return 'bg-warning';
    return 'bg-danger';
}

function formatCurrency(amount) {
    return parseFloat(amount).toLocaleString('en-US', {
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
    });
}

function changeReportType() {
    loadReportData();
}

function updateDateRange() {
    const range = document.getElementById('dateRange').value;
    const customRange = document.getElementById('customDateRange');
    
    if (range === 'custom') {
        customRange.style.display = 'block';
    } else {
        customRange.style.display = 'none';
        loadReportData();
    }
}

function applyCustomRange() {
    const startDate = document.getElementById('startDate').value;
    const endDate = document.getElementById('endDate').value;
    
    if (!startDate || !endDate) {
        alert('Please select both start and end dates');
        return;
    }
    
    loadReportData();
}

function initializeDatePickers() {
    const today = new Date();
    const yesterday = new Date(today);
    yesterday.setDate(yesterday.getDate() - 1);
    
    document.getElementById('startDate').valueAsDate = yesterday;
    document.getElementById('endDate').valueAsDate = today;
}

function refreshData() {
    loadReportData();
    showNotification('Data Refreshed', 'Report data has been updated', 'success');
}

function generateReport() {
    const modal = new bootstrap.Modal(document.getElementById('reportGeneratorModal'));
    modal.show();
}

function generateCustomReport(event) {
    event.preventDefault();
    const formData = new FormData(event.target);
    const data = Object.fromEntries(formData);
    
    // Show loading state
    const submitBtn = event.target.querySelector('button[type="submit"]');
    const originalText = submitBtn.innerHTML;
    submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span> Generating...';
    submitBtn.disabled = true;
    
    fetch('/api/generate-report', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            bootstrap.Modal.getInstance(document.getElementById('reportGeneratorModal')).hide();
            event.target.reset();
            
            if (result.download_url) {
                window.open(result.download_url, '_blank');
            }
            
            showNotification('Report Generated', 'Your report has been generated successfully', 'success');
        }
    })
    .finally(() => {
        submitBtn.innerHTML = originalText;
        submitBtn.disabled = false;
    });
}

function exportReport(format) {
    const reportType = document.getElementById('reportType').value;
    const dateRange = document.getElementById('dateRange').value;
    
    window.open(`/api/export-report?type=${reportType}&range=${dateRange}&format=${format}`, '_blank');
}

function showNotification(title, message, type) {
    // Use your notification system here
    alert(`${title}: ${message}`);
}
</script>

<style>
.metric-card {
    border: none;
    border-radius: 10px;
    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    transition: transform 0.3s ease;
}

.metric-card:hover {
    transform: translateY(-5px);
}

.rank-badge {
    width: 30px;
    height: 30px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    color: white;
    margin: 0 auto;
}

.rank-1 {
    background: linear-gradient(135deg, #FFD700, #FFA500);
}

.rank-2 {
    background: linear-gradient(135deg, #C0C0C0, #A0A0A0);
}

.rank-3 {
    background: linear-gradient(135deg, #CD7F32, #A0522D);
}

.rank-4, .rank-5, .rank-6, .rank-7, .rank-8, .rank-9, .rank-10 {
    background: linear-gradient(135deg, #6c757d, #495057);
}

.agency-icon-small {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    background: #e3f2fd;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #1976d2;
}

.performance-score {
    display: flex;
    align-items: center;
    gap: 10px;
}

.score-value {
    font-weight: 600;
    width: 40px;
    text-align: center;
}

.score-bar {
    flex: 1;
    height: 8px;
    background: #e9ecef;
    border-radius: 4px;
    overflow: hidden;
}

.score-fill {
    height: 100%;
    background: linear-gradient(90deg, #667eea, #764ba2);
    border-radius: 4px;
    transition: width 1s ease;
}

.table-hover tbody tr:hover {
    background-color: rgba(102, 126, 234, 0.05);
}

/* Chart containers */
.card-body canvas {
    max-width: 100%;
}

/* Responsive adjustments */
@media (max-width: 768px) {
    .performance-score {
        flex-direction: column;
        gap: 5px;
    }
    
    .score-bar {
        width: 100%;
    }
}
</style>
{% endblock %}